<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Admin Paneli - AYBARS</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2206/2206368.png" type="image/x-icon">

    <style>
        :root { --primary: #403f2b; --bg: #f4f5f7; --white: #ffffff; --border: #e0e0e0; --text: #333; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; --warning: #f39c12; }
        
        html { touch-action: manipulation; }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; display: flex; color: var(--text); height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s ease; z-index: 1001; height: 100vh; flex-shrink: 0; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #666; transition: 0.3s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background-color: var(--primary); color: var(--white); }
        .menu-item i { width: 20px; text-align: center; }
        
        /* CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; transition: 0.3s; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .page-title { font-size: 22px; font-weight: 600; color: #2c3e50; margin: 0; }
        .btn-primary { background-color: var(--primary); color: var(--white); border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .btn-primary:hover { background-color: #2d2c1e; transform: translateY(-2px); }

        /* MOBİL HEADER */
        .top-bar-mobile { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
        .admin-clock-widget { background: #fff; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 10px; font-weight: 600; z-index: 100; }
        .mobile-menu-toggle { display: none; font-size: 24px; cursor: pointer; color: var(--primary); padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); }

        /* TABLOLAR & LİSTELER */
        .table-responsive { overflow-x: auto; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .data-table { width: 100%; background: var(--white); border-collapse: collapse; min-width: 700px; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; color: #555; }
        .data-table tr:hover { background-color: #fafafa; }
        .action-btn { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; margin-right: 5px; color: white; font-size: 12px; }
        .btn-edit { background-color: var(--warning); }
        .btn-delete { background-color: var(--danger); }
        .btn-view { background-color: var(--info); }
        .cat-list { list-style: none; padding: 0; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
        .cat-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .cat-item:last-child { border-bottom: none; }
        .add-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        
        /* GRID SİSTEMLERİ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } 
        .full-width-grid { grid-column: 1 / -1; }

        /* SSS LİSTESİ */
        .faq-item { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .faq-content h4 { margin: 0 0 5px 0; font-size: 14px; color: var(--primary); }
        .faq-content p { margin: 0; font-size: 13px; color: #666; line-height: 1.4; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { 
            background: var(--white); border-radius: 12px; width: 650px; max-width: 90%; 
            max-height: 85vh; 
            display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .modal-header { display: flex; justify-content: space-between; padding: 20px 30px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .modal-body { 
            padding: 30px; overflow-y: auto; flex: 1; 
            -webkit-overflow-scrolling: touch; 
        }
        .modal-footer { 
            padding: 20px 30px; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 0 0 12px 12px; 
            flex-shrink: 0; text-align: right; 
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
        }
        .close-btn { cursor: pointer; font-size: 20px; color: #999; }
        
        /* FORM */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); outline: none; }
        textarea.form-control { resize: vertical; min-height: 80px; }

        .image-upload-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .image-upload-box { flex: 1; border: 2px dashed #ddd; border-radius: 8px; padding: 10px; text-align: center; background: #fafafa; position: relative; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .image-upload-box input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; top:0; left:0; }
        .preview-img-small { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; display: none; margin-top: 5px; }

        .variant-container { margin-top: 10px; }
        .variant-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; align-items: start; gap: 15px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s; }
        .v-input-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
        .v-input-group label { font-size: 11px; color: #888; margin-bottom: 3px; }
        .v-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%; box-sizing: border-box; }

        .v-gallery-area { flex: 1.5; border: 1px dashed #ccc; border-radius: 6px; padding: 5px; background: #fafafa; min-height: 55px; display: flex; flex-wrap: wrap; gap: 5px; position: relative; align-items: center; }
        .v-gallery-area:hover { background: #fff; border-color: var(--primary); }
        .v-gallery-input { position: absolute; width: 100%; height: 100%; top:0; left:0; opacity: 0; cursor: pointer; z-index: 2; }
        .v-gallery-placeholder { width: 100%; text-align: center; font-size: 11px; color: #888; pointer-events: none; }
        .v-thumb { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; z-index: 1; position: relative; }

        .btn-add-variant { background: none; border: 1px dashed #999; color: #666; width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-add-variant:hover { border-color: var(--primary); color: var(--primary); background: #fff; }
        .btn-remove-v { background: #ffebee; color: #c62828; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #ffebee; color: #c62828; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        
        .countdown-timer { font-family: 'JetBrains Mono', monospace; font-weight: bold; color: #e67e22; font-size: 12px; }

        @media (max-width: 992px) {
            body { height: auto; overflow: visible; }
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .mobile-menu-toggle { display: block; }
            .top-bar-mobile { justify-content: space-between; background: none; padding: 0; margin-bottom: 20px; }
            .main-content { padding: 20px; width: 100%; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .settings-grid { grid-template-columns: 1fr; } 
            .full-width-grid { grid-column: auto; }
            .header-area { flex-direction: column; align-items: stretch; gap: 15px; }
            .btn-primary[style*="margin-right"] { margin-right: 0 !important; }
            .add-row { flex-direction: column; align-items: stretch; }
            .add-row div, .add-row button { width: 100%; }
            .add-row button { justify-content: center; }
            input, textarea, select, .form-control { font-size: 16px !important; }
            .modal-content { width: 95%; max-height: 80dvh; }
            .modal-body { padding: 20px; }
            .modal-footer { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #eee; z-index: 100; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="mainSidebar">
        <div class="logo"><i class="fas fa-couch"></i> AYBARS Admin</div>
        <div class="menu-item active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Ana Sayfa</div>
        <div class="menu-item" onclick="showSection('products')"><i class="fas fa-box"></i> Ürünler</div>
        <div class="menu-item" onclick="showSection('categories')"><i class="fas fa-list"></i> Kategoriler</div>
        <div class="menu-item" onclick="showSection('coupons')"><i class="fas fa-tags"></i> Kuponlar</div>
        <div class="menu-item" onclick="showSection('orders')"><i class="fas fa-shopping-cart"></i> Siparişler</div>
        <div class="menu-item" onclick="showSection('settings')"><i class="fas fa-cog"></i> Ayarlar</div>
        <div class="menu-item" style="margin-top:auto; color:#e74c3c;" onclick="cikisYap()"><i class="fas fa-sign-out-alt"></i> Çıkış</div>
    </div>

    <div class="main-content">
        
        <div class="top-bar-mobile">
            <i class="fas fa-bars mobile-menu-toggle" onclick="toggleMenu()"></i>
            <div class="admin-clock-widget">
                <i class="far fa-clock"></i> <span id="adminLiveClock">--:--:--</span>
            </div>
        </div>

        <div id="dashboard" class="section active">
            <div class="header-area"><h2 class="page-title">Genel Bakış</h2></div>
            <div class="dashboard-grid">
                <div style="background:#fff; padding:20px; border-radius:10px; border:1px solid #eee;">
                    <h3 style="margin:0 0 10px 0; color:#888; font-size:14px;">Toplam Ürün</h3>
                    <span style="font-size:24px; font-weight:bold;" id="dashProductCount">0</span>
                </div>
                <div style="background:#fff; padding:20px; border-radius:10px; border:1px solid #eee;">
                    <h3 style="margin:0 0 10px 0; color:#888; font-size:14px;">Toplam Sipariş</h3>
                    <span style="font-size:24px; font-weight:bold;" id="dashOrderCount">0</span>
                </div>
                <div style="background:#fff; padding:20px; border-radius:10px; border:1px solid #eee;">
                    <h3 style="margin:0 0 10px 0; color:#888; font-size:14px;">Toplam Ciro</h3>
                    <span style="font-size:24px; font-weight:bold;" id="dashRevenue">₺0.00</span>
                </div>
            </div>
        </div>

        <div id="products" class="section">
            <div class="header-area">
                <h2 class="page-title">Ürün Yönetimi</h2>
                <button class="btn-primary" onclick="urunModalAc()" style="margin-right: 150px;"><i class="fas fa-plus"></i> Yeni Ürün</button>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead><tr><th>Resim</th><th>Ürün Adı</th><th>Kategori</th><th>Fiyat</th><th>Stok</th><th>İşlemler</th></tr></thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="categories" class="section">
            <div class="header-area"><h2 class="page-title">Kategori Yönetimi</h2></div>
            <div style="background:#fff; padding:20px; border-radius:10px; max-width:600px;">
                <div class="add-row">
                    <input type="text" id="newCatName" class="form-control" placeholder="Yeni Kategori Adı">
                    <button class="btn-primary" onclick="kategoriEkle()">Ekle</button>
                </div>
                <ul id="catListDisplay" class="cat-list"></ul>
            </div>
        </div>

        <div id="coupons" class="section">
            <div class="header-area"><h2 class="page-title">İndirim Kuponları</h2></div>
            <div style="background:#fff; padding:20px; border-radius:10px; max-width:750px;">
                <div class="add-row" style="background:#fafafa; padding:15px; border-radius:8px; border:1px solid #eee; display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:150px;">
                        <label style="font-size:12px; font-weight:bold; color:#555;">Kupon Kodu</label>
                        <input type="text" id="newCouponCode" class="form-control" placeholder="Örn: YAZ20" style="text-transform:uppercase;">
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <label style="font-size:12px; font-weight:bold; color:#555;">İndirim (%)</label>
                        <input type="number" id="newCouponRate" class="form-control" placeholder="20">
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <label style="font-size:12px; font-weight:bold; color:#555;">Süre (Saat)</label>
                        <input type="number" id="newCouponDuration" class="form-control" placeholder="Boş=Süresiz">
                    </div>
                    <div style="align-self:flex-end;">
                        <button class="btn-primary" onclick="kuponEkle()">Ekle</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table" style="margin-top:20px;">
                        <thead><tr><th>Kupon Kodu</th><th>İndirim</th><th>Kalan Süre</th><th>Durum</th><th>İşlem</th></tr></thead>
                        <tbody id="couponTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="orders" class="section">
            <div class="header-area"><h2 class="page-title">Siparişler</h2></div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead><tr><th>Sipariş No</th><th>Müşteri</th><th>Tarih</th><th>Tutar</th><th>Durum</th><th>İşlem</th></tr></thead>
                    <tbody id="orderTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="header-area"><h2 class="page-title">Site Ayarları</h2></div>
            <div class="settings-grid"> 
                <div style="background:#fff; padding:30px; border-radius:10px;">
                    <h3 style="margin-top:0;">İletişim Bilgileri</h3>
                    <div class="form-group"><label>Firma Adresi</label><textarea id="setAddress" class="form-control" rows="3"></textarea></div>
                    <div class="form-group"><label>Telefon</label><input type="text" id="setPhone" class="form-control"></div>
                    <div class="form-group"><label>E-Posta</label><input type="text" id="setEmail" class="form-control"></div>
                    <button class="btn-primary" onclick="ayarlariKaydet()">Kaydet</button>
                </div>
                <div style="background:#fff; padding:30px; border-radius:10px;">
                    <h3 style="margin-top:0;">Sayfa İçerik Yönetimi</h3>
                    <div class="form-group">
                        <label>Düzenlenecek Sayfa</label>
                        <select id="pageSelector" class="form-control" onchange="sayfaIcerigiYukle(this.value)">
                            <option value="about">Hakkımızda</option>
                            <option value="contact">İletişim (Harita)</option>
                            <option value="returns">İade Koşulları</option>
                            <option value="privacy">Gizlilik Politikası</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sayfa Metni / Harita Linki</label>
                        <textarea id="pageContent" class="form-control" rows="6" placeholder="Buraya yazınız..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="sayfaIcerigiKaydet()">Güncelle</button>
                </div>
                <div style="background:#fff; padding:30px; border-radius:10px;" class="full-width-grid">
                    <h3 style="margin-top:0;">Sıkça Sorulan Sorular (SSS)</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="newFaqQuestion" class="form-control" placeholder="Soru yazın..." style="flex: 1; min-width: 200px;">
                        <input type="text" id="newFaqAnswer" class="form-control" placeholder="Cevap yazın..." style="flex: 2; min-width: 200px;">
                        <button class="btn-primary" onclick="sssEkle()">Ekle</button>
                    </div>
                    <div id="faqListDisplay" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

    </div>

    <div id="orderDetailModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Sipariş Detayı <span id="odNo" style="color:#888; font-size:16px;"></span></h3>
                <div class="close-btn" onclick="siparisModalKapat()">&times;</div>
            </div>
            <div class="modal-body">
                <div style="background:#fcfcfc; border:1px solid #eee; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="font-size:12px; color:#888; margin-bottom:4px;">TARİH</div><div id="odTarih" style="font-weight:600;">-</div></div>
                    <div><div style="font-size:12px; color:#888; margin-bottom:4px;">MÜŞTERİ</div><div id="odMusteri" style="font-weight:600;">-</div></div>
                    <div><div style="font-size:12px; color:#888; margin-bottom:4px;">DURUM</div><div id="odDurum">-</div></div>
                </div>
                <h4 style="font-size:14px; color:#403f2b; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">TESLİMAT BİLGİLERİ</h4>
                <div id="odAdres" style="font-size:13px; color:#555; line-height:1.6; margin-bottom:25px; padding-left:10px;"></div>
                <h4 style="font-size:14px; color:#403f2b; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;">ÜRÜNLER</h4>
                <div id="odUrunler" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
            <div class="modal-footer" style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9;">
                <div style="font-size:18px; font-weight:bold; color:#333;">TOPLAM: <span id="odToplam" style="color:#403f2b;"></span></div>
                <button class="btn-primary" id="btnInvoiceGo"><i class="fas fa-file-invoice"></i> Faturayı Görüntüle</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Ürün Ekle / Düzenle</h3><div class="close-btn" onclick="modalKapat()">&times;</div></div>
            <input type="hidden" id="editId">
            <div class="modal-body">
                <div class="form-group"><label>Ürün Adı</label><input type="text" id="pName" class="form-control"></div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>Kategori</label><select id="pCat" class="form-control"></select></div>
                    <div style="flex:1;"><label>Fiyat (₺)</label><input type="number" id="pPrice" class="form-control"></div>
                </div>
                <label style="font-size:13px; font-weight:500; color:#555; margin-bottom:5px; display:block;">Vitrin Resimleri</label>
                <div class="image-upload-row">
                    <div class="image-upload-box"><i class="fas fa-camera"></i><span>Kapak Resmi</span><input type="file" id="pImg1" onchange="previewImage(this, 'prev1')"><img id="prev1" class="preview-img-small"></div>
                    <div class="image-upload-box"><i class="fas fa-camera"></i><span>2. Resim</span><input type="file" id="pImg2" onchange="previewImage(this, 'prev2')"><img id="prev2" class="preview-img-small"></div>
                </div>
                <div class="form-group"><label>Açıklama</label><textarea id="pDesc" class="form-control"></textarea></div>
                <div style="border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
                    <label style="font-weight:600; margin-bottom:10px; display:block;">Renk ve Stok Varyasyonları</label>
                    <div id="variantContainer" class="variant-container"></div>
                    <button type="button" class="btn-add-variant" onclick="varyasyonEkle()"><i class="fas fa-plus-circle"></i> Yeni Renk Seçeneği Ekle</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary" id="btnProductSave" onclick="urunKaydet()" style="width:100%; justify-content:center;">KAYDET</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL_PRODUCTS = "/api/products";
        const API_URL_ORDERS = "/api/orders";

        let urunler = [];
        let siparisler = [];
        
        let kategoriler = JSON.parse(localStorage.getItem('aybarsKategoriler')) || [{id:'masa', ad:'Masa'}, {id:'sandalye', ad:'Sandalye'}, {id:'koltuk', ad:'Koltuk'}];
        let kuponlar = JSON.parse(localStorage.getItem('aybarsKuponlar')) || [];
        let sssListesi = JSON.parse(localStorage.getItem('aybars_faq')) || [];

        // --- SAYFA YÜKLENDİĞİNDE ---
        document.addEventListener("DOMContentLoaded", function() {
            baslatAdminSaati(); 
            kategoriListesiniGuncelle();
            ayarlariYukle();
            verileriGetir();
            baslatKuponSayaci(); 
            sayfaIcerigiYukle(document.getElementById('pageSelector').value); 
            sssYukle();
        });

        // --- VERİ ÇEKME ---
        async function verileriGetir() {
            try {
                const resProd = await fetch(API_URL_PRODUCTS);
                urunler = await resProd.json();
                
                const resOrd = await fetch(API_URL_ORDERS);
                siparisler = await resOrd.json();

                // Kuponları API'den çek
                const resCoupon = await fetch("/api/coupons");
                if(resCoupon.ok) {
                    kuponlar = await resCoupon.json();
                }
                
                tabloyuYenile();
                siparisTablosunuYenile();
                kuponTablosunuYenile();
                dashboardGuncelle();
            } catch (error) {
                console.error("Veri çekme hatası:", error);
            }
        }

        // --- GÖRSEL ARAYÜZ ---
        function toggleMenu() { document.getElementById('mainSidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function showSection(id) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active')); event.currentTarget.classList.add('active'); if(window.innerWidth <= 992) toggleMenu(); }
        function baslatAdminSaati() { const c = document.getElementById('adminLiveClock'); setInterval(() => { c.innerText = new Date().toLocaleTimeString('tr-TR'); }, 1000); }
        function cikisYap(){ if(confirm("Çıkış yapılsın mı?")) { localStorage.removeItem('isLoggedIn'); localStorage.removeItem('authToken'); localStorage.removeItem('aybarsUser'); window.location.href = "index.html"; } }

        // --- KATEGORİ YÖNETİMİ ---
        function kategoriListesiniGuncelle() { localStorage.setItem('aybarsKategoriler', JSON.stringify(kategoriler)); const ul = document.getElementById('catListDisplay'); ul.innerHTML = ''; kategoriler.forEach((k, i) => { ul.innerHTML += `<li class="cat-item"><span>${k.ad}</span><button class="action-btn btn-delete" onclick="kategoriSil(${i})"><i class="fas fa-trash"></i></button></li>`; }); const sel = document.getElementById('pCat'); sel.innerHTML = ''; kategoriler.forEach(k => { sel.innerHTML += `<option value="${k.id}">${k.ad}</option>`; }); }
        function kategoriEkle() { const ad = document.getElementById('newCatName').value.trim(); if(!ad) return; const id = ad.toLowerCase().replace(/ /g, '-').replace(/ğ/g,'g').replace(/ü/g,'u').replace(/ş/g,'s').replace(/ı/g,'i').replace(/ö/g,'o').replace(/ç/g,'c'); kategoriler.push({id, ad}); document.getElementById('newCatName').value = ''; kategoriListesiniGuncelle(); }
        function kategoriSil(index) { if(confirm('Silinsin mi?')) { kategoriler.splice(index, 1); kategoriListesiniGuncelle(); } }

        // --- KUPON YÖNETİMİ (GÜNCELLENDİ: Auth + Backend Delete) ---
        function kuponTablosunuYenile() { 
            const t = document.getElementById('couponTableBody'); t.innerHTML = ''; 
            if (kuponlar.length === 0) { t.innerHTML = '<tr><td colspan="5" style="text-align:center;">Kupon Yok</td></tr>'; return; } 
            kuponlar.forEach((k, i) => { 
                let s = '<span style="color:#2ecc71;">Süresiz</span>', d = '<span class="badge badge-success">Aktif</span>'; 
                if (k.bitisTarihi) { 
                    if (Date.now() > k.bitisTarihi) { s = '<span style="color:#e74c3c;">Bitti</span>'; d = '<span class="badge badge-danger">Pasif</span>'; } 
                    else { s = `<span class="countdown-timer" data-expire="${k.bitisTarihi}">...</span>`; } 
                } 
                // Silme butonuna ID gönderiyoruz
                const silParam = k._id ? `'${k._id}'` : i; 
                t.innerHTML += `<tr><td>${k.kod}</td><td>%${k.oran}</td><td>${s}</td><td>${d}</td><td><button class="action-btn btn-delete" onclick="kuponSil(${silParam})"><i class="fas fa-trash"></i></button></td></tr>`; 
            }); 
        }
        function baslatKuponSayaci() { setInterval(() => { document.querySelectorAll('.countdown-timer').forEach(el => { const b = parseInt(el.getAttribute('data-expire')), n = Date.now(), r = b - n; if (r <= 0) { el.style.color = '#e74c3c'; el.innerText = 'Bitti'; } else { const h = Math.floor(r / 36e5), m = Math.floor((r % 36e5) / 6e4), s = Math.floor((r % 6e4) / 1e3); el.innerText = `${h}s ${m}dk ${s}sn`; } }); }, 1000); }
        
        async function kuponEkle() {
            const k = document.getElementById('newCouponCode').value.trim().toUpperCase();
            const o = parseInt(document.getElementById('newCouponRate').value);
            const h = parseInt(document.getElementById('newCouponDuration').value);
            
            if (!k || !o) return alert("Eksik bilgi");
            
            // TOKEN KONTROLÜ
            const token = localStorage.getItem('authToken');
            if(!token) return alert("Yetkisiz işlem! Lütfen giriş yapın.");

            const b = h ? Date.now() + (h * 36e5) : null;
            const yeniKupon = { kod: k, oran: o, bitisTarihi: b };

            try {
                const res = await fetch("/api/coupons", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token // GÜVENLİK
                    },
                    body: JSON.stringify(yeniKupon)
                });

                if(res.ok) {
                    alert("Kupon Sisteme Kaydedildi!");
                    await verileriGetir(); 
                    document.getElementById('newCouponCode').value = '';
                    document.getElementById('newCouponRate').value = '';
                    document.getElementById('newCouponDuration').value = '';
                } else {
                    const err = await res.json();
                    alert("Hata: " + (err.message || "Bilinmeyen hata"));
                }
            } catch(e) { console.error(e); alert("Sunucu hatası."); }
        }

        async function kuponSil(param) { 
            if(!confirm("Silinsin mi?")) return;

            // Eğer parametre string ise (ID) backend'den sil
            if (typeof param === 'string') {
                const token = localStorage.getItem('authToken');
                if(!token) return alert("Yetkisiz işlem!");

                try {
                    const res = await fetch(`/api/coupons/${param}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if(res.ok) {
                        await verileriGetir();
                    } else {
                        alert("Silinemedi (Yetki sorunu olabilir)");
                    }
                } catch(e) { alert("Hata oluştu"); }
            } else {
                // ID yoksa (eski usul yerel kayıt) sadece arrayden sil
                kuponlar.splice(param, 1); 
                localStorage.setItem('aybarsKuponlar', JSON.stringify(kuponlar)); 
                kuponTablosunuYenile(); 
            }
        }

        // --- SİPARİŞ YÖNETİMİ ---
        function siparisTablosunuYenile() { 
            const t = document.getElementById('orderTableBody'); t.innerHTML = ''; 
            siparisler.forEach(s => { 
                let c = '#f39c12'; 
                if(s.durum === 'Kargolandı') c = '#3498db'; 
                if(s.durum === 'Teslim Edildi') c = '#2ecc71'; 
                if(s.durum === 'İptal') c = '#e74c3c'; 
                const kisaId = s._id ? s._id.slice(-6).toUpperCase() : (s.siparisNo || '???');
                const tarih = new Date(s.tarih).toLocaleDateString('tr-TR');
                
                t.innerHTML += `<tr>
                    <td>#${kisaId}</td>
                    <td>${s.musteriIsim} ${s.musteriSoyisim}</td>
                    <td>${tarih}</td>
                    <td>₺${(s.toplamTutar||0).toFixed(2)}</td>
                    <td>
                        <select onchange="durumDegistir('${s._id}', this.value)" style="padding:5px;border-radius:4px;border:1px solid #ddd;font-weight:bold;color:white;background-color:${c}">
                            <option value="Hazırlanıyor" style="color:#333;background:#fff;" ${s.durum==='Hazırlanıyor'?'selected':''}>Hazırlanıyor</option>
                            <option value="Kargolandı" style="color:#333;background:#fff;" ${s.durum==='Kargolandı'?'selected':''}>Kargolandı</option>
                            <option value="Teslim Edildi" style="color:#333;background:#fff;" ${s.durum==='Teslim Edildi'?'selected':''}>Teslim Edildi</option>
                            <option value="İptal" style="color:#333;background:#fff;" ${s.durum==='İptal'?'selected':''}>İptal</option>
                        </select>
                    </td>
                    <td><button class="action-btn btn-view" onclick="siparisDetayAc('${s._id}')"><i class="fas fa-eye"></i></button></td>
                </tr>`; 
            }); 
        }

        function durumDegistir(id, yeni) { 
            const ix = siparisler.findIndex(s => s._id == id); 
            if(ix === -1) return; 
            siparisler[ix].durum = yeni; 
            siparisTablosunuYenile();
            alert("Görsel güncellendi (Backend entegrasyonu için PUT route gerekir)");
        }

        function siparisDetayAc(id) {
            const s = siparisler.find(x => x._id == id);
            if(!s) return;
            document.getElementById('odNo').innerText = '#' + (s._id ? s._id.slice(-6).toUpperCase() : '');
            document.getElementById('odTarih').innerText = new Date(s.tarih).toLocaleString('tr-TR');
            document.getElementById('odMusteri').innerText = s.musteriIsim + ' ' + s.musteriSoyisim;
            
            let b = 'badge-warning';
            if(s.durum === 'Kargolandı') b = 'badge-info';
            if(s.durum === 'Teslim Edildi') b = 'badge-success';
            if(s.durum === 'İptal') b = 'badge-danger';
            document.getElementById('odDurum').innerHTML = `<span class="badge ${b}">${s.durum}</span>`;
            document.getElementById('odAdres').innerHTML = s.adres + ' - ' + s.sehir;
            document.getElementById('odToplam').innerText = "₺" + (s.toplamTutar||0).toFixed(2);

            const p = document.getElementById('odUrunler');
            p.innerHTML = '';
            
            if(s.urunler) {
                s.urunler.forEach(u => {
                    const img = u.resim || 'https://via.placeholder.com/60';
                    const renk = u.secilenRenk ? `<span style="font-size:11px; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px;">Renk: ${u.secilenRenk}</span>` : '';
                    p.innerHTML += `
                        <div style="display:flex; align-items:center; background:#fff; border:1px solid #eee; padding:10px; border-radius:6px;">
                            <div style="width:60px; height:60px; flex-shrink:0; border-radius:4px; overflow:hidden; border:1px solid #eee; margin-right:15px;">
                                <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:600; color:#333; margin-bottom:4px;">${u.isim}</div>
                                <div style="color:#666; font-size:12px;">${renk}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; color:#888;">${u.adet} Adet x ₺${u.fiyat}</div>
                                <div style="font-weight:bold; color:#333; margin-top:2px;">₺${(u.fiyat * u.adet).toFixed(2)}</div>
                            </div>
                        </div>`;
                });
            }
            document.getElementById('btnInvoiceGo').onclick = function(){ window.open(`invoice.html?id=${s._id}`, '_blank') };
            document.getElementById('orderDetailModal').style.display = 'flex';
        }
        function siparisModalKapat() { document.getElementById('orderDetailModal').style.display = 'none'; }

        // --- ÜRÜN İŞLEMLERİ (GÜNCELLENDİ: Auth Ekli) ---
        function urunModalAc(id=null) { 
            document.getElementById('productModal').style.display='flex'; 
            const c=document.getElementById('variantContainer'); c.innerHTML=''; 
            if(id) { 
                const u = urunler.find(x => x._id == id); 
                document.getElementById('editId').value=u._id; 
                document.getElementById('pName').value=u.isim; 
                document.getElementById('pPrice').value=u.fiyat; 
                document.getElementById('pCat').value=u.kategori; 
                document.getElementById('pDesc').value=u.aciklama||''; 
                if(u.resim1){document.getElementById('prev1').src=u.resim1;document.getElementById('prev1').style.display='block'} 
                if(u.resim2){document.getElementById('prev2').src=u.resim2;document.getElementById('prev2').style.display='block'} 
                if(u.stokDetaylari) { Object.keys(u.stokDetaylari).forEach(r => varyasyonEkle(r, u.stokDetaylari[r], (u.renkDetaylari&&u.renkDetaylari[r])?u.renkDetaylari[r]:[])); } 
            } else { 
                document.getElementById('editId').value=''; 
                document.getElementById('pName').value=''; 
                document.getElementById('pPrice').value=''; 
                document.getElementById('pDesc').value=''; 
                document.getElementById('prev1').style.display='none'; 
                document.getElementById('prev2').style.display='none'; 
                varyasyonEkle(); 
            } 
        }
        function modalKapat() { document.getElementById('productModal').style.display='none'; }
        
        function varyasyonEkle(r='', s='', imgs=[]) { const d=document.createElement('div'); d.className='variant-card'; let h=''; imgs.forEach(i=>{h+=`<img src="${i}" class="v-thumb">`}); d.innerHTML=`<div class="v-input-group"><label>Renk</label><input type="text" class="v-input var-color" value="${r}"></div><div class="v-input-group"><label>Stok</label><input type="number" class="v-input var-stock" value="${s}"></div><div class="v-input-group" style="flex:1.5"><label>Resimler</label><div class="v-gallery-area"><input type="file" multiple class="v-gallery-input" onchange="previewVariantImages(this)"><div class="v-thumbs-container" style="display:flex;gap:5px;">${h}</div></div></div><button class="btn-remove-v" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>`; document.getElementById('variantContainer').appendChild(d); }
        function previewImage(i,id) { if(i.files&&i.files[0]){const r=new FileReader(); r.onload=e=>{document.getElementById(id).src=e.target.result;document.getElementById(id).style.display='block'}; r.readAsDataURL(i.files[0]);} }
        function previewVariantImages(i) { const c=i.parentElement.querySelector('.v-thumbs-container'); if(i.files.length>0){ c.innerHTML=''; const f=Array.from(i.files).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true})); Promise.all(f.map(file=>new Promise(res=>{const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file)}))).then(imgs=>{imgs.forEach(src=>{const m=document.createElement('img'); m.src=src; m.className='v-thumb'; c.appendChild(m)})}); } }
        
        // --- ÜRÜN KAYDETME (TOKEN EKLİ) ---
        async function urunKaydet() {
            try {
                // TOKEN KONTROLÜ
                const token = localStorage.getItem('authToken');
                if(!token) return alert("Hata: Oturum kapalı. Lütfen giriş yapın.");

                const btn = document.getElementById('btnProductSave');
                const orgText = btn.innerText; btn.innerText = 'Kaydediliyor...'; btn.disabled = true;
                
                const id=document.getElementById('editId').value; 
                const n=document.getElementById('pName').value; 
                const p=document.getElementById('pPrice').value; 
                const c=document.getElementById('pCat').value; 
                const d=document.getElementById('pDesc').value; 
                const i1=document.getElementById('prev1').src; 
                const i2=document.getElementById('prev2').src;
                
                let sD={}, rD={}, tS=0;
                document.querySelectorAll('.variant-card').forEach(el=>{ 
                    const r=el.querySelector('.var-color').value.trim(); 
                    const s=parseInt(el.querySelector('.var-stock').value)||0; 
                    const thumbs=el.querySelectorAll('.v-thumb'); 
                    let im=[]; 
                    thumbs.forEach(t=>{if(t.src&&!t.src.includes('window.location')) im.push(t.src)}); 
                    if(r){sD[r]=s; tS+=s; if(im.length>0) rD[r]=im;} 
                });
                
                if(!n || !p) { alert('İsim ve fiyat zorunlu!'); btn.innerText = orgText; btn.disabled = false; return; }
                
                const obj = {
                    isim:n, fiyat:Number(p), kategori:c, aciklama:d, 
                    resim1:i1.includes('base64')?i1:'', 
                    resim2:i2.includes('base64')?i2:'', 
                    stok:tS, stokDetaylari:sD, renkDetaylari:rD
                };

                // HEADERS HAZIRLA
                const myHeaders = {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                };

                let response;
                if(id) { 
                    response = await fetch(`${API_URL_PRODUCTS}/${id}`, {
                        method: 'PUT', headers: myHeaders, body: JSON.stringify(obj)
                    });
                } else { 
                    response = await fetch(API_URL_PRODUCTS, {
                        method: 'POST', headers: myHeaders, body: JSON.stringify(obj)
                    });
                }

                if(response.ok) {
                    modalKapat(); await verileriGetir(); alert('Başarıyla kaydedildi!');
                } else {
                    const err = await response.json();
                    alert('Hata: ' + (err.message || "Yetkisiz işlem"));
                }
                btn.innerText = orgText; btn.disabled = false;
            } catch(e) { 
                alert('Sunucu hatası: ' + e.message); 
                document.getElementById('btnProductSave').disabled = false;
            }
        }

        // --- ÜRÜN SİLME (TOKEN EKLİ) ---
        async function urunSil(id) { 
            if(confirm('Bu ürün tamamen silinecek. Emin misiniz?')) {
                const token = localStorage.getItem('authToken');
                if(!token) return alert("Yetkisiz işlem!");

                try {
                    const res = await fetch(`${API_URL_PRODUCTS}/${id}`, { 
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    if(res.ok) {
                        await verileriGetir();
                    } else {
                        alert("Silinemedi. Yetkiniz olmayabilir.");
                    }
                } catch(e) { alert("Sunucu hatası"); }
            } 
        }

        function tabloyuYenile() { 
            const t=document.getElementById('productTableBody'); t.innerHTML=''; 
            urunler.forEach(u=>{ 
                const i=u.resim1||''; 
                t.innerHTML+=`<tr>
                    <td><img src="${i}" style="width:40px;border-radius:4px;"></td>
                    <td>${u.isim}</td>
                    <td>${u.kategori}</td>
                    <td>₺${u.fiyat}</td>
                    <td>${u.stok}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="urunModalAc('${u._id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="urunSil('${u._id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
        }

        // --- DİĞER AYARLAR ---
        function ayarlariKaydet() { const d={address:document.getElementById('setAddress').value, phone:document.getElementById('setPhone').value, email:document.getElementById('setEmail').value}; localStorage.setItem('aybars_contact',JSON.stringify(d)); alert('Kaydedildi'); }
        
        function sayfaIcerigiKaydet() { 
            const k=document.getElementById('pageSelector').value; 
            const icerik = document.getElementById('pageContent').value; 
            const kayit = { title: document.getElementById('pageSelector').options[document.getElementById('pageSelector').selectedIndex].text, content: icerik };
            localStorage.setItem('aybars_content_' + k, JSON.stringify(kayit)); 
            alert('Güncellendi'); 
        }

        function sayfaIcerigiYukle(k) { 
            const d = JSON.parse(localStorage.getItem('aybars_content_' + k)) || {}; 
            document.getElementById('pageContent').value = d.content || ''; 
        }

        function sssYukle() { const d=document.getElementById('faqListDisplay'); d.innerHTML=''; sssListesi.forEach((f,i)=>{ d.innerHTML+=`<div class="faq-item"><div class="faq-content"><h4>${f.q}</h4><p>${f.a}</p></div><button class="action-btn btn-delete" onclick="sssSil(${i})"><i class="fas fa-trash"></i></button></div>`; }); }
        function sssEkle() { const q=document.getElementById('newFaqQuestion').value.trim(); const a=document.getElementById('newFaqAnswer').value.trim(); if(!q||!a) return; sssListesi.push({q,a}); localStorage.setItem('aybars_faq', JSON.stringify(sssListesi)); document.getElementById('newFaqQuestion').value=''; document.getElementById('newFaqAnswer').value=''; sssYukle(); }
        function sssSil(i) { if(confirm('Silinsin mi?')){sssListesi.splice(i,1); localStorage.setItem('aybars_faq', JSON.stringify(sssListesi)); sssYukle();} }

        function ayarlariYukle() { 
            const d=JSON.parse(localStorage.getItem('aybars_contact')); if(d){document.getElementById('setAddress').value=d.address||''; document.getElementById('setPhone').value=d.phone||''; document.getElementById('setEmail').value=d.email||''} 
            sssListesi = JSON.parse(localStorage.getItem('aybars_faq')) || [];
            sssYukle();
        }
        
        function dashboardGuncelle() { 
            document.getElementById('dashProductCount').innerText=urunler.length; 
            document.getElementById('dashOrderCount').innerText=siparisler.length; 
            let c=0; 
            siparisler.forEach(s=>{ c += s.toplamTutar || 0; }); 
            document.getElementById('dashRevenue').innerText="₺"+c.toFixed(2); 
        }
    </script>
</body>
</html>