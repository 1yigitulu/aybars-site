<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AYBARS | Minimalist Furniture</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5997/5997108.png" type="image/x-icon">

    <style>
        /* --- ÖZEL MODERN TASARIM AYARLARI --- */
        :root {
            --primary-color: #403f2b;
            --accent-color: #a93c3c;
            --bg-color: #fcfcfc;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-light: #777777;
            --border-light: #eaeaea;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.04);
            --shadow-hover: 0 15px 35px rgba(0,0,0,0.08);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Inter', sans-serif;
        }

        /* --- MOBİL KATEGORİ ÇUBUĞU (YENİLENMİŞ PREMİUM TASARIM) --- */
        .mobile-category-bar {
            display: none; /* Masaüstünde gizli */
            grid-column: 1 / -1;
            overflow-x: auto;
            white-space: nowrap;
            gap: 12px;
            padding: 10px 5px 10px 5px; /* Alt boşluk azaltıldı */
            margin-bottom: 30px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox scrollbar gizle */
            border-bottom: 1px solid transparent;
        }

        .mobile-category-bar::-webkit-scrollbar { display: none; } /* Chrome gizle */

        .cat-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            background-color: #fff;
            border: 1px solid var(--border-light);
            border-radius: 50px; /* Tam yuvarlak kenarlar */
            color: var(--text-main);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            letter-spacing: 0.5px;
        }

        .cat-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
            border-color: #ccc;
        }

        .cat-pill.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(64, 63, 43, 0.3);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .mobile-category-bar { display: flex; }
        }

        /* --- ÜRÜN KARTLARI (MODERNLEŞTİRİLMİŞ) --- */
        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.4s ease;
            position: relative;
            border: 1px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
            border-color: var(--border-light);
        }

        .product-image-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 3 / 4; /* Daha modern dikey oran */
            height: auto !important; /* CSS dosyasındaki sabitlemeyi ezmek için */
            overflow: hidden;
            background-color: #f4f4f4;
            border-radius: 12px 12px 0 0;
        }

        .product-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .product-card:hover .product-image-wrapper img {
            transform: scale(1.05); /* Hafif zoom efekti */
        }

        .product-info {
            padding: 15px;
            text-align: center;
        }

        .product-info h4 {
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-info p {
            font-family: 'Playfair Display', serif; /* Fiyat için şık font */
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        /* --- SIRALAMA & FİLTRE ALANI --- */
        .catalog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            grid-column: 1 / -1;
        }
        
        .result-count { 
            font-size: 13px; 
            color: var(--text-light); 
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Özel Select Dropdown Tasarımı */
        .custom-select-wrapper { position: relative; user-select: none; width: 220px; font-family: 'Inter', sans-serif; font-size: 13px; }
        .custom-select-trigger { position: relative; display: flex; align-items: center; justify-content: flex-end; cursor: pointer; color: var(--text-main); gap: 10px; padding: 8px 0; transition: all 0.3s; }
        .custom-select-trigger:hover { color: var(--primary-color); }
        .custom-select-trigger span { font-weight: 600; }
        .custom-select-trigger i { font-size: 10px; transition: transform 0.3s; color: #999; }
        .custom-select-wrapper.open .custom-select-trigger i { transform: rotate(180deg); }
        
        .custom-options { 
            position: absolute; top: 100%; right: 0; 
            background: #fff; border: 1px solid var(--border-light); 
            box-shadow: var(--shadow-soft); border-radius: 8px; 
            overflow: hidden; opacity: 0; visibility: hidden; 
            transform: translateY(10px); transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); 
            z-index: 99; min-width: 200px; 
        }
        
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .custom-option { padding: 12px 20px; cursor: pointer; color: var(--text-light); transition: 0.2s; display: block; font-weight: 500; }
        .custom-option:hover { background-color: #f9f9f9; color: var(--primary-color); padding-left: 24px; }
        .custom-option.selected { font-weight: 700; color: var(--primary-color); background-color: #f4f4f4; }

        /* --- RENK TOPLARI (SWATCHES) --- */
        .product-colors-wrapper { display: flex; justify-content: center; gap: 6px; margin-top: 10px; flex-wrap: wrap; height: 20px; }
        .color-swatch { 
            width: 14px; height: 14px; border-radius: 50%; 
            border: 1px solid rgba(0,0,0,0.1); 
            cursor: pointer; transition: transform 0.2s; position: relative; 
        }
        .color-swatch:hover { transform: scale(1.3); border-color: var(--primary-color); z-index: 2; }
        
        /* Renk Sınıfları */
        .bg-beyaz { background-color: #ffffff; border:1px solid #ddd; } .bg-siyah { background-color: #000000; } .bg-antrasit { background-color: #383e42; } .bg-krem { background-color: #fffdd0; } .bg-gri { background-color: #808080; } .bg-mavi { background-color: #0000ff; } .bg-yesil { background-color: #008000; } .bg-kahverengi { background-color: #a52a2a; } .bg-kirmizi { background-color: #ff0000; } .bg-sari { background-color: #ffff00; } .bg-bej { background-color: #f5f5dc; } .bg-lacivert { background-color: #000080; } .bg-turuncu { background-color: #FFA500; } .bg-mor { background-color: #800080; } .bg-pembe { background-color: #FFC0CB; } .bg-turkuaz { background-color: #40E0D0; } .bg-bordo { background-color: #800020; } .bg-default { background: #ccc; }
        /* --- QUICK VIEW DÜZELTİLMİŞ TASARIM --- */
.qv-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; visibility: hidden; transition: 0.3s;
    backdrop-filter: blur(3px); /* Arka planı bulanıklaştırır */
}

.qv-overlay.active { opacity: 1; visibility: visible; }

.qv-modal {
    background: #fff; width: 900px; max-width: 90%; height: 500px;
    display: flex; border-radius: 8px; overflow: hidden;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2); position: relative;
}

/* Sol Taraf: Resim Alanı */
.qv-image-area {
    flex: 1.2; /* Resim alanı biraz daha geniş olsun */
    background: #f9f9f9; position: relative;
    display: flex; flex-direction: column; justify-content: center;
}

.qv-image-container {
    width: 100%; height: 100%; position: relative;
    display: flex; align-items: center; justify-content: center;
}

.qv-main-img {
    max-width: 90%; max-height: 80%; object-fit: contain;
    mix-blend-mode: multiply; /* Beyaz arka planı yok eder */
}

/* Sağ Taraf: Detaylar */
.qv-details {
    flex: 1; padding: 40px;
    display: flex; flex-direction: column; justify-content: center;
    text-align: left;
}

.qv-close {
    position: absolute; top: 15px; right: 20px;
    background: none; border: none; font-size: 30px; cursor: pointer;
    color: #555; z-index: 10;
}

.qv-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 10px; font-family: 'Playfair Display', serif; }
.qv-price { font-size: 22px; color: #403f2b; font-weight: 600; margin-bottom: 20px; }
.qv-desc { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 30px; flex-grow: 1; overflow-y: auto; }

.qv-link {
    background: #403f2b; color: #fff; text-decoration: none;
    padding: 15px; text-align: center; border-radius: 4px;
    font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
    transition: 0.2s; margin-top: auto; /* En alta iter */
}
.qv-link:hover { background: #2d2c1e; }

/* Ok Tuşları */
.qv-nav-btn {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: rgba(255,255,255,0.8); border: 1px solid #ddd;
    width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s; z-index: 5;
}
.qv-nav-btn:hover { background: #403f2b; color: #fff; }
.qv-prev { left: 15px; } .qv-next { right: 15px; }

/* Küçük Resimler (Thumbnails) */
.qv-thumbnails {
    position: absolute; bottom: 15px; width: 100%;
    display: flex; justify-content: center; gap: 8px;
}
.qv-thumb {
    width: 40px; height: 40px; object-fit: cover; border-radius: 4px;
    border: 1px solid #ddd; cursor: pointer; opacity: 0.6; transition: 0.2s;
    background: #fff;
}
.qv-thumb.active, .qv-thumb:hover { opacity: 1; border-color: #403f2b; transform: scale(1.1); }

/* MOBİL UYUMLULUK */
@media (max-width: 768px) {
    .qv-modal { flex-direction: column; height: auto; max-height: 90vh; overflow-y: auto; }
    .qv-image-area { height: 300px; flex: none; }
    .qv-details { padding: 20px; }
}
    </style>
</head>
<body>

    <header></header> <section class="hero-section" id="dynamic-hero"></section>

    <section class="container">
        <aside class="sidebar">
            <h3>Koleksiyonlar</h3>
            <ul id="sidebar-kategoriler">
                </ul>
        </aside>

        <div class="mobile-cat-trigger-wrapper">
            <button class="btn-mobile-cat" onclick="toggleCategorySidebar()">
                <i class="fas fa-bars"></i> KATEGORİLER
            </button>
        </div>

<div id="categorySidebarOverlay" class="cat-sidebar-overlay" onclick="toggleCategorySidebar()"></div>
<aside id="categorySidebar" class="cat-sidebar">
    <div class="cat-sidebar-header">
        <h3>KOLEKSİYONLAR</h3>
        <button class="close-cat-sidebar" onclick="toggleCategorySidebar()">&times;</button>
    </div>
    <ul id="mobile-category-list-content">
        </ul>
</aside>

        <main class="product-grid" id="main-grid-container">
            
            <div class="catalog-header">
                <span class="result-count" id="urunSayisi">Yükleniyor...</span>
                
                <div class="custom-select-wrapper" id="sortWrapper">
                    <div class="custom-select-trigger" onclick="toggleSortMenu()">
                        <span id="sortTriggerText">Sıralama: Varsayılan</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="custom-options">
                        <span class="custom-option selected" onclick="customSortSec('varsayilan', 'Varsayılan')">Önerilen</span>
                        <span class="custom-option" onclick="customSortSec('yeni', 'En Yeniler')">En Yeniler</span>
                        <span class="custom-option" onclick="customSortSec('artan', 'Fiyat: Düşükten Yükseğe')">Fiyat: Artan</span>
                        <span class="custom-option" onclick="customSortSec('azalan', 'Fiyat: Yüksekten Düşüğe')">Fiyat: Azalan</span>
                        <span class="custom-option" onclick="customSortSec('isim-az', 'İsim A-Z')">İsim A-Z</span>
                        <span class="custom-option" onclick="customSortSec('isim-za', 'İsim Z-A')">İsim Z-A</span>
                    </div>
                </div>
            </div>

            <div id="urun-listesi" style="display:contents;"></div>
        </main>
    </section>

    <footer></footer> <div id="quickViewOverlay" class="qv-overlay">
        <div class="qv-modal">
            <button class="qv-close" onclick="closeQuickView()">&times;</button>
            <div class="qv-image-area">
                <div class="qv-image-container">
                    <button class="qv-nav-btn qv-prev" onclick="changeQvImage(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="qv-nav-btn qv-next" onclick="changeQvImage(1)"><i class="fas fa-chevron-right"></i></button>
                    <img id="qv-img" class="qv-main-img" src="" alt="Ürün Resmi">
                    <div id="qv-thumbnails" class="qv-thumbnails"></div>
                </div>
            </div>
            <div class="qv-details">
                <h2 id="qv-title" class="qv-title">Ürün Adı</h2>
                <p id="qv-price" class="qv-price">₺0.00</p>
                <p id="qv-desc" class="qv-desc">Açıklama...</p>
                <a id="qv-btn" href="#" class="qv-link">ÜRÜNE GİT</a>
            </div>
        </div>
    </div>

    <div id="searchOverlay" class="search-overlay">
        <button class="close-search" onclick="toggleSearch()">&times;</button>
        <div class="search-box-wrapper">
            <input type="text" id="searchInput" class="search-input" placeholder="Ürün Ara..." oninput="urunAra()">
            <div id="searchResults" class="search-results"></div>
        </div>
        
    </div>

    <div id="mobileOverlay" class="mobile-sidebar-overlay" onclick="toggleMobileMenu()"></div>
    <nav id="mobileNav" class="mobile-nav">
        <button class="close-mobile-menu" onclick="toggleMobileMenu()">&times;</button>
        <h3>Menü</h3>
        <ul>
            <li><a href="index.html">Ana Sayfa</a></li>
            <li><a href="favorites.html">Favorilerim</a></li>
            <li><a href="cart.html">Sepetim</a></li>
            <li><a href="orders.html">Siparişlerim</a></li>
        </ul>
        <h3>Koleksiyonlar</h3>
        <ul id="mobile-cat-list"></ul>
    </nav>

    <script src="layout.js"></script>

    <script>
    // --- BACKEND API URL ---
    const API_URL = "/api";

    // --- GLOBAL DEĞİŞKENLER ---
    let globalUrunVerisi = [];
    let filtrelenmisUrunler = [];
    let currentQvImages = []; 
    let currentQvIndex = 0;   
    let aktifSiralamaTipi = 'varsayilan';

    // --- SAYFA YÜKLENDİĞİNDE ---
    document.addEventListener("DOMContentLoaded", async function() {
        // Slider ve Kategoriler (Local'den devam ediyor şimdilik)
        renderHeroSlider(); 
        
        // Ürünleri Backend'den Çek
        await urunleriGetir();

        // Diğer yüklemeler
        activeLinkBoyama();
        mobilKategorileriDoldur(); 
        
        // Masaüstü Sidebar'ı doldur (Kategoriler LocalStorage'dan)
        const sb = document.getElementById('sidebar-kategoriler');
        const k = JSON.parse(localStorage.getItem('aybarsKategoriler')) || [];
        if(sb){ 
            sb.innerHTML=`<li><a href="index.html" class="cat-link" data-cat="hepsi">Tüm Ürünler</a></li>`; 
            k.forEach(c=>sb.innerHTML+=`<li><a href="?kategori=${c.id}" class="cat-link">${c.ad}</a></li>`); 
        }
    });

    // --- YENİLENMİŞ: ÜRÜNLERİ BACKEND'DEN ÇEKME (HIZLI ROTA) ---
    async function urunleriGetir() {
        try {
            // URL'deki kategori bilgisini al
            const params = new URLSearchParams(window.location.search);
            const aktifKategori = params.get('kategori');
            
            // DÜZELTME: Artık ana sayfa için özel, hızlı ve filtrelenmiş rotayı kullanıyoruz
            let requestUrl = `${API_URL}/products/public`;
            
            // Eğer kategori varsa Backend'e bildir (Backend boş kategoriyi boş döndürecek)
            if (aktifKategori && aktifKategori !== 'hepsi') {
                requestUrl += `?kategori=${aktifKategori}`;
            }

            const response = await fetch(requestUrl);
            if(!response.ok) throw new Error("Ürünler çekilemedi");
            
            const urunler = await response.json();
            
            // Veriyi işle ve global değişkene ata
            globalUrunVerisi = urunler.map(u => ({
                ...u,
                id: u._id 
            }));
            
            // Backend zaten filtrelediği için, gelen veri direkt filtrelenmiş veridir.
            filtrelenmisUrunler = [...globalUrunVerisi];
            
            // Ekrana bas
            siralamayiUygula(true);
            
        } catch (error) {
            console.error("Hata:", error);
            document.getElementById('urun-listesi').innerHTML = `<div style="padding:20px; text-align:center; color:red;">Ürünler yüklenirken hata oluştu. Lütfen sunucunun (Backend) açık olduğundan emin olun.</div>`;
        }
    }

    // --- KATEGORİ SIDEBAR FONKSİYONLARI ---
    function toggleCategorySidebar() {
        document.getElementById('categorySidebar').classList.toggle('active');
        document.getElementById('categorySidebarOverlay').classList.toggle('active');
    }

    function mobilKategorileriDoldur() {
        const list = document.getElementById('mobile-category-list-content');
        const k = JSON.parse(localStorage.getItem('aybarsKategoriler')) || [];
        if(!list) return;

        const p = new URLSearchParams(window.location.search);
        const aktifKat = p.get('kategori');

        let html = `<li><a href="index.html" class="${!aktifKat || aktifKat==='hepsi' ? 'active-cat' : ''}">Tüm Ürünler</a></li>`;
        k.forEach(c => {
            const isActive = aktifKat === c.id ? 'active-cat' : '';
            html += `<li><a href="?kategori=${c.id}" class="${isActive}">${c.ad}</a></li>`;
        });
        list.innerHTML = html;
    }

    // --- SIRALAMA MENÜSÜ ---
    function toggleSortMenu() { document.getElementById('sortWrapper').classList.toggle('open'); }
    
    function customSortSec(deger, metin) {
        document.getElementById('sortTriggerText').innerText = "Sıralama: " + metin;
        document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
        event.target.classList.add('selected');
        document.getElementById('sortWrapper').classList.remove('open');
        aktifSiralamaTipi = deger;
        siralamayiUygula();
    }
    
    window.addEventListener('click', function(e) { const wrapper = document.getElementById('sortWrapper'); if (!wrapper.contains(e.target)) wrapper.classList.remove('open'); });

    function siralamayiUygula(render = true) {
        const secim = aktifSiralamaTipi;
        
        // Sıralama işlemi artık filtrelenmiş veriler üzerinde yapılıyor
        if (secim === 'artan') { 
            filtrelenmisUrunler.sort((a, b) => parseFloat(a.fiyat) - parseFloat(b.fiyat)); 
        } 
        else if (secim === 'azalan') { 
            filtrelenmisUrunler.sort((a, b) => parseFloat(b.fiyat) - parseFloat(a.fiyat)); 
        } 
        else if (secim === 'yeni') { 
            filtrelenmisUrunler.sort((a, b) => {
                if(a.id > b.id) return -1;
                if(a.id < b.id) return 1;
                return 0;
            });
        } 
        else if (secim === 'isim-az') { filtrelenmisUrunler.sort((a, b) => a.isim.localeCompare(b.isim)); } 
        else if (secim === 'isim-za') { filtrelenmisUrunler.sort((a, b) => b.isim.localeCompare(a.isim)); } 
        
        if (render) renderUrunler();
    }

    /* --- ÜRÜN LİSTELEME FONKSİYONU --- */
    function renderUrunler(){
        const div = document.getElementById('urun-listesi');
        const countSpan = document.getElementById('urunSayisi');
        if(!div) return;

        div.innerHTML = "";
        countSpan.innerText = `${filtrelenmisUrunler.length} ürün bulundu`;

        if(filtrelenmisUrunler.length === 0) {
            div.innerHTML = `<div style="grid-column:span 3; text-align:center; padding:50px; color:#666;"><h3>Ürün Bulunamadı</h3><p>Bu kategoride henüz ürün yok.</p></div>`;
            return;
        }

        filtrelenmisUrunler.forEach(u => {
            // Renk Seçenekleri
            let colorSwatchesHTML = "";
            if (u.renkDetaylari && typeof u.renkDetaylari === 'object' && !Array.isArray(u.renkDetaylari)) {
                const renkler = Object.keys(u.renkDetaylari);
                if(renkler.length > 0) {
                    colorSwatchesHTML = '<div class="product-colors-wrapper">';
                    renkler.forEach(renkAdi => {
                        let safeRenkAdi = renkAdi.toLowerCase().replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c').replace(/[^a-z0-9]/g, '-');
                        
                        colorSwatchesHTML += `<div class="color-swatch bg-${safeRenkAdi}" 
                                                data-color-name="${renkAdi}" 
                                                data-product-id="${u.id}" 
                                                title="${renkAdi}" 
                                                onclick="renkDegistir(this, event)" 
                                                onmouseenter="renkOnizlemeAc(this)" 
                                                onmouseleave="renkOnizlemeKapat(this)"></div>`;
                    });
                    colorSwatchesHTML += '</div>';
                }
            }

            const anaResim = u.resim1 || 'https://via.placeholder.com/300x400?text=Resim+Yok';
            const hoverResim = u.resim2 || anaResim;
            let favClass = "";
            // favKontrol fonksiyonu layout.js'de
            if(typeof favKontrol === 'function') favClass = favKontrol(u.id);

            div.innerHTML += `
                <div class="product-card" onclick="window.location.href='product.html?id=${u.id}'">
                    
                    <button class="btn-fav card-fav-btn ${favClass}" onclick="favoriYonet('${u.id}', this); event.stopPropagation();">
                        <i class="fas fa-heart"></i>
                    </button>
                    
                    <button class="card-quick-view-btn" onclick="openQuickView('${u.id}', event)" title="Hızlı Bakış">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <div class="product-image-wrapper">
                        <img src="${anaResim}" class="primary-img" id="img-${u.id}">
                        <img src="${hoverResim}" class="secondary-img" style="filter:brightness(0.9);">
                    </div>
                    
                    <div class="product-info">
                        <h4>${u.isim}</h4>
                        <p>₺${u.fiyat}</p>
                        ${colorSwatchesHTML}
                    </div>
                </div>
            `;
        });
    }

    /* --- RENK DEĞİŞTİRME FONKSİYONU --- */
    function renkDegistir(element, event) {
        event.stopPropagation();
        event.preventDefault();

        const urunId = element.getAttribute('data-product-id');
        const renkAdi = element.getAttribute('data-color-name');
        
        // Ürünü bul
        const urun = globalUrunVerisi.find(u => u.id == urunId);
        
        if (urun && urun.renkDetaylari && urun.renkDetaylari[renkAdi]) {
            const resimListesi = urun.renkDetaylari[renkAdi];
            if (Array.isArray(resimListesi) && resimListesi.length > 0) {
                const yeniResimSrc = resimListesi[0];
                const imgElement = document.getElementById(`img-${urunId}`);
                if (imgElement) {
                    imgElement.style.opacity = '0.7';
                    setTimeout(() => {
                        imgElement.src = yeniResimSrc;
                        imgElement.style.opacity = '1';
                    }, 100);
                }
            }
        }
    }

    // --- RENK DEĞİŞTİRME (HOVER EFFECT) ---
    function renkOnizlemeAc(element) {
        try {
            const urunId = element.getAttribute('data-product-id');
            const renkAdi = element.getAttribute('data-color-name');
            const urun = globalUrunVerisi.find(u => u.id == urunId);
            if (urun && urun.renkDetaylari && urun.renkDetaylari[renkAdi]) {
                const resimListesi = urun.renkDetaylari[renkAdi];
                if (Array.isArray(resimListesi) && resimListesi.length > 0 && resimListesi[0]) {
                    const kart = element.closest('.product-card');
                    const img = kart.querySelector('.primary-img');
                    const secondary = kart.querySelector('.secondary-img');
                    if (!img.getAttribute('data-original')) img.setAttribute('data-original', img.src);
                    img.src = resimListesi[0];
                    img.style.setProperty('opacity', '1', 'important'); 
                    if(secondary) { secondary.style.setProperty('opacity', '0', 'important'); secondary.style.setProperty('visibility', 'hidden', 'important'); }
                }
            }
        } catch(e) { console.log(e); }
    }

    function renkOnizlemeKapat(element) {
        try {
            const kart = element.closest('.product-card');
            if (!kart) return;
            const img = kart.querySelector('.primary-img');
            const secondary = kart.querySelector('.secondary-img');
            const orjinal = img.getAttribute('data-original');
            if (orjinal) img.src = orjinal;
            img.style.removeProperty('opacity');
            if(secondary) { secondary.style.removeProperty('opacity'); secondary.style.removeProperty('visibility'); }
        } catch(e) { console.log(e); }
    }

    // --- SLIDER FONKSİYONLARI ---
    function renderHeroSlider(){
        const c = document.getElementById('dynamic-hero'); if(!c) return;
        let d = JSON.parse(localStorage.getItem('aybarsSliderlar')) || [];
        if(d.length === 0) {
            d = [{ resim: 'https://images.unsplash.com/photo-1618220179428-22790b461013?q=80&w=1600&auto=format&fit=crop', baslik: 'DOĞANIN ESTETİĞİ', aciklama: 'Evinize sıcaklık ve huzur katın.', link: '#main-grid-container', renkBaslik: '#fff', renkAciklama: '#fff' }];
        }
        let slidesHTML = '', dotsHTML = '<div class="slider-dots">';
        d.forEach((s, i) => {
            const activeClass = i === 0 ? 'active' : '';
            slidesHTML += `<div class="hero-slide ${activeClass}"><img src="${s.resim}"><div class="hero-content"><h2 style="color:${s.renkBaslik||'#fff'}">${s.baslik}</h2><p style="color:${s.renkAciklama||'#fff'}">${s.aciklama||''}</p><a href="${s.link}" class="btn-hero" style="color:${s.renkBaslik||'#fff'};border-color:${s.renkBaslik||'#fff'}">İNCELE</a></div></div>`;
            dotsHTML += `<div class="dot ${activeClass}" onclick="slaytGit(${i})"></div>`;
        });
        dotsHTML += '</div>';
        c.innerHTML = `${slidesHTML}<button class="slider-btn prev" onclick="slaytDegistir(-1)"><i class="fas fa-chevron-left"></i></button><button class="slider-btn next" onclick="slaytDegistir(1)"><i class="fas fa-chevron-right"></i></button>${dotsHTML}`;
        window.sliderIndex = 0; if(window.sliderInterval) clearInterval(window.sliderInterval); window.sliderInterval = setInterval(() => slaytDegistir(1), 6000);
    }

    window.slaytDegistir = function(y) {
        const slides = document.querySelectorAll('.hero-slide'); if(slides.length === 0) return;
        let yeniIndex = window.sliderIndex + y;
        if(yeniIndex >= slides.length) yeniIndex = 0; if(yeniIndex < 0) yeniIndex = slides.length - 1;
        slaytGit(yeniIndex);
    }

    window.slaytGit = function(index) {
        const slides = document.querySelectorAll('.hero-slide'); const dots = document.querySelectorAll('.dot'); if(slides.length === 0) return;
        slides[window.sliderIndex].classList.remove('active'); if(dots[window.sliderIndex]) dots[window.sliderIndex].classList.remove('active');
        window.sliderIndex = index;
        slides[window.sliderIndex].classList.add('active'); if(dots[window.sliderIndex]) dots[window.sliderIndex].classList.add('active');
        clearInterval(window.sliderInterval); window.sliderInterval = setInterval(() => slaytDegistir(1), 6000);
    }

    // --- QUICK VIEW (HIZLI BAKIŞ) ---
    function openQuickView(id, e) {
        if(e) e.stopPropagation();
        
        // Bu ürünün DETAYLI verisine ihtiyacımız var (resimler vb. için)
        // Eğer global veride detay yoksa (çünkü server.js'de detayları çıkardık), tekil istek at
        // Şimdilik hızlı çözüm: Kullanıcı tıkladığında fetch yapabiliriz veya kapak resmiyle idare edebiliriz.
        // En doğrusu: Tıklanınca fetch yapmak.
        
        fetch(`${API_URL}/products/${id}`)
            .then(res => res.json())
            .then(urun => {
                document.getElementById('qv-title').innerText = urun.isim; 
                document.getElementById('qv-price').innerText = "₺" + urun.fiyat; 
                document.getElementById('qv-desc').innerText = urun.aciklama || "Açıklama bulunmuyor."; 
                document.getElementById('qv-btn').href = "product.html?id=" + urun._id;
                
                currentQvImages = [];
                if(urun.resim1) currentQvImages.push(urun.resim1); 
                if(urun.resim2) currentQvImages.push(urun.resim2);
                if(urun.renkDetaylari && typeof urun.renkDetaylari === 'object') { 
                    Object.values(urun.renkDetaylari).forEach(resimListesi => { 
                        if(Array.isArray(resimListesi)) resimListesi.forEach(r => currentQvImages.push(r)); 
                    }); 
                }
                currentQvImages = [...new Set(currentQvImages)];
                currentQvIndex = 0; 
                
                updateQvImage();
                
                const thumbContainer = document.getElementById('qv-thumbnails'); 
                thumbContainer.innerHTML = ""; 
                currentQvImages.forEach((src, index) => { 
                    if(!src) return; 
                    const thumb = document.createElement('img'); 
                    thumb.src = src; 
                    thumb.className = index === 0 ? 'qv-thumb active' : 'qv-thumb'; 
                    thumb.dataset.index = index; 
                    thumb.onclick = function() { currentQvIndex = parseInt(this.dataset.index); updateQvImage(); }; 
                    thumbContainer.appendChild(thumb); 
                });
                
                const prevBtn = document.querySelector('.qv-prev'); const nextBtn = document.querySelector('.qv-next');
                if(currentQvImages.length <= 1) { 
                    if(prevBtn) prevBtn.style.display = 'none'; 
                    if(nextBtn) nextBtn.style.display = 'none'; 
                } else { 
                    if(prevBtn) prevBtn.style.display = 'flex'; 
                    if(nextBtn) nextBtn.style.display = 'flex'; 
                }
                
                document.getElementById('quickViewOverlay').classList.add('active');
            })
            .catch(err => console.error("Detay yüklenemedi", err));
    }

    function changeQvImage(direction) { if(currentQvImages.length <= 1) return; currentQvIndex += direction; if (currentQvIndex >= currentQvImages.length) currentQvIndex = 0; if (currentQvIndex < 0) currentQvIndex = currentQvImages.length - 1; updateQvImage(); }
    function updateQvImage() { const mainImg = document.getElementById('qv-img'); if(!mainImg || currentQvImages.length === 0) return; mainImg.style.opacity = 0; setTimeout(() => { mainImg.src = currentQvImages[currentQvIndex]; mainImg.style.opacity = 1; }, 200); document.querySelectorAll('.qv-thumb').forEach((t, i) => { t.classList.toggle('active', i === currentQvIndex); if(i===currentQvIndex) t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }); }
    function closeQuickView() { document.getElementById('quickViewOverlay').classList.remove('active'); }
    const overlay = document.getElementById('quickViewOverlay'); if(overlay) { overlay.addEventListener('click', function(e) { if(e.target === this) closeQuickView(); }); }
    function activeLinkBoyama(){ const p=new URLSearchParams(window.location.search), c=p.get('kategori'); document.querySelectorAll('.cat-link').forEach(l=>{ if((c&&l.href.includes(c))||(!c&&l.dataset.cat==='hepsi')){ l.style.fontWeight="bold"; l.style.color="#403f2b"; } }); }
    document.addEventListener('keydown', e=>{ if(e.key==='F2')window.location.href='admin.html'; });
    </script>
</body>
</html>