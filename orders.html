<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siparişlerim - AYBARS</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5997/5997108.png" type="image/x-icon">
    <style>
        .orders-container { max-width: 1000px; margin: 40px auto; padding: 0 20px; min-height: 60vh; }
        .page-title { text-align: center; font-family: 'Times New Roman', serif; margin-bottom: 40px; }
        .order-card { border: 1px solid #e0dfd5; padding: 25px; margin-bottom: 30px; background: #fff; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap:10px; align-items: center; }
        .order-info span { display: block; font-size: 13px; color: #888; margin-bottom: 2px; }
        .order-info strong { font-size: 15px; color: #333; }
        .order-status { background: #f0f0f0; padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #403f2b; height: fit-content; }
        .order-item-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .order-item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #f9f9f9; border: 1px solid #eee; }
        .no-orders { text-align: center; padding: 50px; color: #666; }
        .btn-small { display:inline-block; margin-top:10px; font-size:14px; text-decoration:underline; color:#403f2b; }

        /* Fatura Butonu Stili */
        .btn-invoice { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 1px solid #403f2b; color: #403f2b; text-decoration: none; border-radius: 4px; font-size: 13px; transition: all 0.3s ease; background-color: transparent; height: fit-content; }
        .btn-invoice:hover { background-color: #403f2b; color: #fff; }
    </style>
</head>
<body>

    <header></header>

    <section class="orders-container">
        <h1 class="page-title">Geçmiş Siparişlerim</h1>
        <div id="orders-list">
            <p style="text-align:center; color:#999;">Siparişleriniz yükleniyor...</p>
        </div>
    </section>

    <footer></footer>

    <div id="searchOverlay" class="search-overlay"><button class="close-search" onclick="toggleSearch()">&times;</button><div class="search-box-wrapper"><input type="text" id="searchInput" class="search-input" placeholder="Ürün Ara..." oninput="urunAra()"><div id="searchResults" class="search-results"></div></div></div>
    <div id="mobileOverlay" class="mobile-sidebar-overlay" onclick="toggleMobileMenu()"></div>
    <nav id="mobileNav" class="mobile-nav"><button class="close-mobile-menu" onclick="toggleMobileMenu()">&times;</button><h3>Menü</h3><ul><li><a href="index.html">Ana Sayfa</a></li><li><a href="favorites.html">Favorilerim</a></li><li><a href="cart.html">Sepetim</a></li><li><a href="orders.html">Siparişlerim</a></li></ul><ul id="mobile-cat-list"></ul></nav>

    <script src="layout.js"></script>

    <script>
        const API_URL = "/api";

        document.addEventListener("DOMContentLoaded", function() {
            siparisleriGetir();
        });

        async function siparisleriGetir() {
            const container = document.getElementById('orders-list');
            const user = JSON.parse(localStorage.getItem('aybarsUser'));
            
            // Kullanıcı giriş yapmamışsa login'e at
            if (!user) { window.location.href = 'login.html'; return; }
            
            try {
                // Backend'den veriyi çek
                const response = await fetch(`${API_URL}/orders`);
                if (!response.ok) throw new Error("Veri çekilemedi");
                
                const tumSiparisler = await response.json();
                
                // Backend'den gelen veriyi filtrele (email eşleşmesi)
                const kullaniciSiparisleri = tumSiparisler.filter(s => s.email === user.email);

                if (kullaniciSiparisleri.length === 0) {
                    container.innerHTML = `<div class="no-orders"><h2>Henüz siparişiniz yok.</h2><a href="index.html" class="btn-small">Alışverişe Başla</a></div>`;
                    return;
                }

                container.innerHTML = ''; // Yükleniyor yazısını temizle

                // Siparişleri listele (En yenisi en üstte)
                kullaniciSiparisleri.reverse().forEach(siparis => {
                    let urunlerHTML = '';
                    siparis.urunler.forEach(u => {
                        const renk = u.secilenRenk ? `(${u.secilenRenk})` : '';
                        // Not: Backend'de henüz resim URL'si saklamadığımız için placeholder kullanıyoruz.
                        // İleride veritabanına resim eklersek buraya u.resim yazacağız.
                        const resimSrc = u.resim || 'https://via.placeholder.com/60?text=Urun';
                        
                        urunlerHTML += `
                            <div class="order-item-row">
                                <img src="${resimSrc}" class="order-item-img">
                                <div class="order-item-details">
                                    <h4>${u.isim} ${renk}</h4>
                                    <p>${u.adet} Adet x ₺${u.fiyat}</p>
                                </div>
                            </div>`;
                    });

                    // Tarihi ve Fiyatı formatla
                    const tarihFormat = new Date(siparis.tarih).toLocaleDateString('tr-TR');
                    const siparisNo = siparis._id.slice(-6).toUpperCase(); // ID'nin son 6 hanesi
                    const fiyatFormat = siparis.toplamTutar ? siparis.toplamTutar.toFixed(2) : "0.00";

                    container.innerHTML += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info"><span>Sipariş No</span><strong>#${siparisNo}</strong></div>
                                <div class="order-info"><span>Tarih</span><strong>${tarihFormat}</strong></div>
                                <div class="order-info"><span>Toplam</span><strong>₺${fiyatFormat}</strong></div>
                                <div class="order-status">${siparis.durum || 'İşleniyor'}</div>
                                <a href="invoice.html?id=${siparis._id}" target="_blank" class="btn-invoice">
                                    <i class="fas fa-file-pdf"></i> Fatura
                                </a>
                            </div>
                            <div class="order-items">${urunlerHTML}</div>
                        </div>`;
                });
            } catch (error) {
                console.error("Hata:", error);
                container.innerHTML = `<div style="text-align:center; color:red; margin-top:50px;">Siparişler yüklenirken bir sorun oluştu.</div>`;
            }
        }
    </script>
</body>
</html>